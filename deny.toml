# =============================================================================
# CARGO DENY CONFIGURATION (v0.16+)
# =============================================================================
# Dependency auditing for security vulnerabilities, license compliance,
# and supply chain safety.
# Run: cargo deny check
# Docs: https://embarkstudios.github.io/cargo-deny/
# =============================================================================

[graph]
# Target platforms to check (add more as needed)
targets = [
  "x86_64-unknown-linux-gnu",
  "x86_64-apple-darwin",
  "aarch64-apple-darwin",
  "aarch64-unknown-linux-gnu",
]
# Exclude dev-dependencies from checks
exclude-dev = true

# =============================================================================
# ADVISORIES - Security vulnerability checks (v0.16+ format)
# =============================================================================
# In cargo-deny 0.16+, all advisory types are denied by default.
# Use `ignore` to allowlist specific advisories with documented reasons.
[advisories]
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]

# How to handle unmaintained crates:
# - "all": deny any unmaintained advisory
# - "workspace": only deny if direct dependency of workspace (recommended)
# - "transitive": only deny if direct dep or transitive of workspace dep
# - "none": ignore unmaintained advisories
unmaintained = "workspace"

# Ignore specific advisories (document why if added)
ignore = [
  # Example: "RUSTSEC-2020-0001", # Reason for ignoring
]

# =============================================================================
# LICENSES - License compliance
# =============================================================================
[licenses]
# Be conservative: only allow well-known permissive licenses
allow = [
  "MIT",
  "Apache-2.0",
  "Apache-2.0 WITH LLVM-exception",
  "BSD-2-Clause",
  "BSD-3-Clause",
  "ISC",
  "Unlicense",
  "Zlib",
  "CC0-1.0",
  "MPL-2.0",                        # Mozilla Public License (weak copyleft, compatible)
  "Unicode-3.0",                    # Unicode License (used by unicode-ident)
  "OpenSSL",                        # Needed for aws-lc-sys
  "CDLA-Permissive-2.0",            # Needed for webpki-root-certs
]

# NOTE: Copyleft licenses (GPL, AGPL, LGPL) are implicitly denied
# because they are not in the allow list above.
# cargo-deny 0.16+ uses allow-list only; the `deny` field was removed.

# Confidence threshold for license detection
confidence-threshold = 0.8

# Clarify ambiguous or missing licenses
[[licenses.clarify]]
name = "ring"
expression = "MIT AND ISC AND OpenSSL"
license-files = [{ path = "LICENSE", hash = 0xbd0eed23 }]

# Private crates in this workspace don't need license files
[licenses.private]
ignore = true

# =============================================================================
# BANS - Dependency bans and restrictions
# =============================================================================
[bans]
# Deny multiple versions of the same crate (reduces binary size)
multiple-versions = "warn"

# Wildcards in dependencies are dangerous (but allow workspace deps)
wildcards = "deny"

# Highlight duplicate dependencies in output
highlight = "all"

# Workspace dependency inheritance
workspace-default-features = "allow"
external-default-features = "allow"

# Deny specific crates (security or policy reasons)
deny = [
  # Example: { name = "openssl", wrappers = ["openssl-sys"] },
]

# Skip specific crates from duplicate detection
skip = [
  # Example: { name = "windows-sys", version = "*" },
]

# Tree-skip to ignore transitive duplicates
skip-tree = [
  # Example: { name = "windows-sys", version = "*" },
]

# =============================================================================
# SOURCES - Crate source restrictions
# =============================================================================
[sources]
# Only allow crates from crates.io (no git dependencies in production)
unknown-registry = "deny"
unknown-git = "deny"

# Allow GitHub sources for specific crates (if needed during development)
allow-git = [
  # Example: "https://github.com/example/crate",
]

# Trusted registries (only crates.io by default)
allow-registry = ["https://github.com/rust-lang/crates.io-index"]

# =============================================================================
# NOTES
# =============================================================================
# This configuration enforces:
# 1. No known security vulnerabilities (RUSTSEC advisories)
# 2. Permissive licenses only (MIT, Apache-2.0, BSD, etc.)
# 3. No wildcard dependencies
# 4. Warning on multiple versions of same crate
# 5. Crates.io as the primary source (git sources warned)
# =============================================================================
